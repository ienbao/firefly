#intgrr
A2 <- c(0, 1.880603141, 1.023066041, 0.728508985, 0.576801714, 0.483324732, 0.419339282, 0.372553625, 0.336700337, 0.308214197,
0.285072182, 0.265815041, 0.249415556, 0.235334231, 0.223098119, 0.212344281, 0.202788984, 0.194260105, 0.186567417, 0.179603854,
0.173280485, 0.167478960, 0.162141846, 0.157220138, 0.152632918, 0.148422908, 0.144445902, 0.140786369, 0.137314768, 0.134048595,
0.131003138, 0.128130004, 0.125386067, 0.122820663, 0.120363768, 0.118035883, 0.115801118, 0.113706604, 0.111691342, 0.109750497,
0.107929345, 0.106147684, 0.104474928, 0.102834701, 0.101294133, 0.099780255, 0.098335949, 0.096957614, 0.095620578, 0.094322825,
0.093062478, 0.091858059, 0.090706954, 0.089567418, 0.088477672, 0.087416455, 0.086401328, 0.085393301, 0.084428606, 0.083487462,
0.082586678, 0.081707137, 0.080830726, 0.080008534, 0.079187956, 0.078385581, 0.077617182, 0.076865294, 0.076129334, 0.075408745,
0.074718677, 0.074027092, 0.073364697, 0.072715370, 0.072078685, 0.071454236, 0.070856317, 0.070255038, 0.069679267, 0.069099752,
0.068544794, 0.067999708, 0.067464204, 0.066951695, 0.066434399, 0.065939323, 0.065439219, 0.064960608, 0.064489832, 0.064026679,
0.063570942, 0.063122426, 0.062680941, 0.062246303, 0.061830756, 0.061409189, 0.061006179, 0.060597033, 0.060205939, 0.059820538)

D3 <- c(0, 0, 0, 0, 0, 0, 0.075591716, 0.136143309, 0.184040404, 0.223099415,
0.255625591, 0.283149171, 0.307194245, 0.328147931, 0.346601382, 0.363052095, 0.377842809, 0.391263736, 0.403496883, 0.414698795,
0.424933827, 0.434485467, 0.443312597, 0.451527599, 0.459374205, 0.467160192, 0.473736803, 0.479766327, 0.485655657, 0.491283407,
0.496539023, 0.501557139, 0.506467227, 0.511037240, 0.515510325, 0.519776912, 0.523955154, 0.527826636, 0.531619856, 0.535337344,
0.538768487, 0.542236872, 0.545430464, 0.548665075, 0.551634881, 0.554648545, 0.557506067, 0.560211151, 0.562866801, 0.565473544,
0.568032565, 0.570450872, 0.572732115, 0.575066257, 0.577266404, 0.579428914, 0.581463144, 0.583553436, 0.585519455, 0.587452468,
0.589265749, 0.591050397, 0.592893713, 0.594535951, 0.596238561, 0.597915941, 0.599484117, 0.601029791, 0.602554384, 0.604058044,
0.605459391, 0.606925251, 0.608290639, 0.609640325, 0.610974407, 0.612294228, 0.613519793, 0.614813030, 0.616015483, 0.617285538,
0.618466996, 0.619639163, 0.620803319, 0.621882184, 0.623032666, 0.624099878, 0.625239268, 0.626298598, 0.627354492, 0.628408180,
0.629460279, 0.630511403, 0.631562160, 0.632613760, 0.633592607, 0.634647413, 0.635631885, 0.636693461, 0.637685903, 0.638683948)

D4 <- c(0, 3.267287234, 2.574246899, 2.281301603, 2.114488392, 2.00394633, 1.924408284, 1.863856691, 1.815959596, 1.776900585,
1.744374409, 1.716850829, 1.692805755, 1.671852069, 1.653398618, 1.636947905, 1.622157191, 1.608736264, 1.596503117, 1.585301205,
1.575066173, 1.565514533, 1.556687403, 1.548472401, 1.540625795, 1.532839808, 1.526263197, 1.520233673, 1.514344343, 1.508716593,
1.503460977, 1.498442861, 1.493532773, 1.488962760, 1.484489675, 1.480223088, 1.476044846, 1.472173364, 1.468380144, 1.464662656,
1.461231513, 1.457763128, 1.454569536, 1.451334925, 1.448365119, 1.445351455, 1.442493933, 1.439788849, 1.437133199, 1.434526456,
1.431967435, 1.429549128, 1.427267885, 1.424933743, 1.422733596, 1.420571086, 1.418536856, 1.416446564, 1.414480545, 1.412547532,
1.410734251, 1.408949603, 1.407106287, 1.405464049, 1.403761439, 1.402084059, 1.400515883, 1.398970209, 1.397445616, 1.395941956,
1.394540609, 1.393074749, 1.391709361, 1.390359675, 1.389025593, 1.387705772, 1.386480207, 1.385186970, 1.383984517, 1.382714462,
1.381533004, 1.380360837, 1.379196681, 1.378117816, 1.376967334, 1.375900122, 1.374760732, 1.373701402, 1.372645508, 1.371591820,
1.370539721, 1.369488597, 1.368437840, 1.367386240, 1.366407393, 1.365352587, 1.364368115, 1.363306539, 1.362314097, 1.361316052)

intgrr.anova.range.fun <- function(x) {
   if (length(na.exclude(x)) == 0) {
      return(NA)
   }
   return(max(x, na.rm = T) - min(x, na.rm = T))
}

intgrr.anova.buildData <- function(x, k, n, r) {
    x[is.nan(x)] <- NaN
    testData <<- data.frame(testResult = x[1: (k * n * r)], Appraisers = rep(gl(k, r, k * r), n), Parts = gl(n, k * r, k * n * r))
    return(testData)
}

intgrr.anova.validityData <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    } 
    aV <- aggregate(testData$testResult, list(testData$Appraisers), mean, na.rm = T)$x
    pV <- aggregate(testData$testResult, list(testData$Parts), mean, na.rm = T)$x
    if (sum(is.nan(aV)) == 0 & sum(is.nan(pV)) == 0 & (k > 1 | n > 1)) {
        Validity <- T
    }else {
        Validity <- F
    }
    return(Validity)
}

intgrr.anova.getAnovaResult <- function(x, k, n, r, pap = 0.05) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    validity <- intgrr.anova.validityData(x, k, n, r)
    if (validity) {
        if (k < 2) {
            fit <- aov(testResult ~ Parts, data = testData)
            anovaData <- summary(fit)[[1]]
            if (r < 2) {
                anovaData[, 'F value'] <- rep(NA, 1)
                anovaData[, 'Pr(>F)'] <- rep(NA, 1)
                anovaData["Residuals",] <- rep(NA, 5)
            }
            add <- rep(NA, length(anovaData))
            anovaData <- rbind("Appraisers" = add, anovaData[1,], "Appraiser:Parts" = add, anovaData[2,])
        } else {
            if (n < 2) {
                fit <- aov(testResult ~ Appraisers, data = testData)
                anovaData <- summary(fit)[[1]]
                add <- rep(NA, length(anovaData))
                anovaData <- rbind(anovaData[, 1], "Parts" = add, "Appraisers:Parts" = add, anovaData[2, ])
            } else {
                fit <- aov(testResult ~ Appraisers + Parts + Appraisers : Parts, data = testData)
                anovaData <- summary(fit)[[1]]
                if (r < 2) {
                    anovaData[, "F value"] <- rep(NA, 3)
                    anovaData[, "Pr(>F)"] <- rep(NA, 3)
                    anovaData["Residuals",] <- rep(NA, 5)
                }
            }
        }
    } else {
        Df <- c(k - 1, n - 1, (k - 1) * (n - 1), n * k * (r - 1))
        x1 <- rep(NA, 4)
        anovaData <- data.frame(Df)
        row.names(anovaData) <- c("Appraisers", "Parts", "Appraisers:Parts", "Residuals")
        anovaData[, "Sum Sq"] <- rep(NA, 4)
        anovaData[, "Mean Sq"] <- rep(NA, 4)
        anovaData[, "F value"] <- rep(NA, 4)
        anovaData[, "Pr(>F)"] <- rep(NA, 4)
    }
    anovaData$'F value'[1] <- anovaData$'Mean Sq'[1] / anovaData$'Mean Sq'[3]
    anovaData$'F value'[2] <- anovaData$'Mean Sq'[2] / anovaData$'Mean Sq'[3]
    anovaData$'Pr(>F)'[1] <- 1 - pf(anovaData$'F value'[1], anovaData$Df[1], anovaData$Df[3])
    anovaData$'Pr(>F)'[2] <- 1 - pf(anovaData$'F value'[2], anovaData$Df[2], anovaData$Df[3])
    p <- anovaData$'Pr(>F)'[3]
    if (p > pap & !is.na(p)) {
        anovaData$'Sum Sq'[4] <- anovaData[3, 2] + anovaData[4, 2]
        anovaData$'Mean Sq'[4] <- anovaData[4, 2] / (anovaData[3, 1] + anovaData[4, 1])
        anovaData$'F value'[1] <- anovaData[1, 3] / anovaData[4, 3]
        anovaData$'F value'[2] <- anovaData[2, 3] / anovaData[4, 3]
        anovaData$'Df'[4] <- anovaData[3, 1] + anovaData[4, 1]
        anovaData[3, 2] <- 0
        anovaData[1, 5] <- pf(anovaData[1, 4], anovaData[1, 1], anovaData[4, 1], lower.tail = F)
        anovaData[2, 5] <- pf(anovaData[2, 4], anovaData[2, 1], anovaData[4, 1], lower.tail = F)
    }
    len <- length(anovaData) - 2
    temp <- c(sum(anovaData[, 1][!is.na(anovaData[, 1])]), sum(anovaData[, 2][!is.na(anovaData[, 2])]), rep(NA, len))
    if (length(na.exclude(anovaData[, 2])) == 0) {
        temp[2] <- NA
    }
    if (p > pap & !is.na(p)) {
        temp[1] <- temp[1] - anovaData[3, 1]
    }
    anovaData["Total", ] <- temp
    anovaResult <<- anovaData
    return(anovaData)
}

intgrr.anova.getSourceResult <- function(x, k, n, r, sig = 6, tole = NA, pap = 0.05) {
    if (!exists("anovaResult")) {
        anovaResult <<- intgrr.anova.getAnovaResult(x, k, n, r, pap)
    }
    an <- anovaResult
    calPap <- an$'Pr(>F)'[3]
    MS <- an$'Mean Sq'
    if (calPap > pap | is.na(calPap)) {
        va <- c(MS[4], NA, (MS[1] - MS[4]) / (n * r), NA, NA, (MS[2] - MS[4]) / (k * r), NA)
    } else {
        va <- c(MS[4], NA, (MS[1] - MS[3]) / (n * r), (MS[3] - MS[4]) / r, NA, (MS[2] - MS[3]) / (k * r), NA)
    }
    va[va < 0] <- NA
    va[2] <- sum(va[3 : 4][!is.na(va[3 : 4])])
    va[5] <- sum(va[1 : 2][!is.na(va[1 : 2])])
    va[7] <- sum(va[5 : 6][!is.na(va[5 : 6])])
    if (length(na.exclude(va[3 : 4])) == 0) {
        va[2] <- NA
    }
    if (length(na.exclude(va[1 : 2])) == 0) {
        va[5] <- NA
    }
    if (length(na.exclude(va[5 : 6])) == 0) {
        va[7] <- NA
    }
    Sigma <- sqrt(va)
    nSigma <- sig * Sigma
    Contribution <- va / va[7] * 100
    Variance <- Sigma / Sigma[7] * 100
    Tolerance <- nSigma / tole * 100
    Tolerance[Tolerance < 0 | Tolerance == Inf] <- NA
    result <- data.frame(va, Sigma, nSigma, Contribution, Variance, Tolerance)
    row.names(result) <- c("Repeatability", "Reproducibility", "Appraisers", "Appraisers x Parts", "Gauge R&R", "Parts", "Total")
    sourceResult <<- result
    return(result)
}

intgrr.anova.getXBBACResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    Xbar <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), mean, na.rm = T)
    Xbar <- Xbar$x
    if (r < 2 | r > 100) {
        UCL <- NA
        LCL <- NA
    } else {
        Rdata <- intgrr.anova.getRangeBACResult(x, k, n, r)$CenterLine
        UCL <- mean(Xbar, na.rm = T) + Rdata * A2[r]
        LCL <- mean(Xbar, na.rm = T) - Rdata * A2[r]
    }
    Xbar <- list(Values = Xbar, UCL = UCL, LCL = LCL, CenterLine = mean(Xbar, na.rm = T))
    return(Xbar)
}

intgrr.anova.getRangeBACResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    Rdata <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), intgrr.anova.range.fun)
    Rdata <- Rdata$x
    if (r < 2 | r > 100) {
        UCL <- NA
        LCL <- NA
    } else {
        UCL <- mean(Rdata, na.rm = T) * D4[r]
        LCL <- mean(Rdata, na.rm = T) * D3[r]
    }
    Rdata <- list(Values = Rdata, UCL = UCL, LCL = LCL, CenterLine = mean(Rdata, na.rm = T))
    return(Rdata)
}

intgrr.anova.getRRBACResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    appraiser <- testData[order(testData$Appraisers, decreasing = F),]
    appraiserData <- matrix(appraiser$testResult, nrow = k, ncol = n * r, byrow = T)
    ave <- matrix(apply(appraiserData, 1, mean, na.rm = T))
    result <- list(Values = appraiserData, CL = as.vector(ave))
    return(result)
}

intgrr.anova.getRRBPCResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    part <- testData[order(testData$Parts, decreasing = F),]
    partData <- matrix(part$testResult, nrow = n, ncol = k * r, byrow = T)
    ave <- matrix(apply(partData, 1, mean, na.rm = T))
    result <- list(Values = partData, CL = as.vector(ave))
    return(result)
}

intgrr.anova.getAPCResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    Xbar <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), mean, na.rm = T)
    PAPlot <- matrix(Xbar$x, nrow = k, ncol = n, byrow = T)
    return(PAPlot)
}

intgrr.anova.getComponentCResult <- function(x, k, n, r, sig = 6, tole = NA, pap = 0.05) {
    if (!exists('sourceResult')) {
        sourceResult <<- intgrr.anova.getSourceResult(x, k, n, r, sig, tole, pap)
    }
    sourceData <- sourceResult
    sourceData <- sourceData[c(-3, -4, -7),]
    sourceData <- sourceData[, c(-1 : -3)]
    componentResult <- t(as.matrix(sourceData))
    rownames(componentResult) <- paste('%', rownames(componentResult))
    return(componentResult)
}

intgrr.anova.getGRRDataSheet <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.anova.buildData(x, k, n, r)
    }
    ra <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), intgrr.anova.range.fun)
    av <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), mean, na.rm = T)
    raP <- aggregate(testData$testResult, list(testData$Parts), intgrr.anova.range.fun)
    avP <- aggregate(testData$testResult, list(testData$Parts), mean, na.rm = T)
    result <- list(Mean = av, Range = ra, TotalMean = avP, TotalRange = raP)
    return(result)
}
