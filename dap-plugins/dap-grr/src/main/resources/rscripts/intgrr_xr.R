#intgrr
int.K2 <- c(0, 0.707108562, 0.523135675, 0.446653892, 0.403024294, 0.374177278, 0.353380616, 0.33750945, 0.324892623, 0.314559381, 0.305895524, 0.298493206, 0.292074841, 0.286437746, 0.281426155, 0.27695384, 0.272909378, 0.269234083, 0.265874008, 0.262786536)

int.K3 <- int.K2

int.Krow <- c(0, 0.707108562, 0.523135675, 0.446653892, 0.403024294, 0.374177278, 0.353380616, 0.33750945, 0.324892623, 0.314559381, 0.305895524, 0.298493206, 0.292074841, 0.286437746, 0.281426155, 0.27695384, 0.272909378, 0.269234083, 0.265874008, 0.262786536,
0, 0.78167137, 0.55390001, 0.464967057, 0.41582808, 0.383968545, 0.361299087, 0.344160627, 0.330637535, 0.31962259, 0.310429821, 0.302605738, 0.295843108, 0.28992062, 0.284667523, 0.279989696, 0.275766977, 0.271935693, 0.26843908, 0.265229477,
0, 0.812314691, 0.56542537, 0.471589114, 0.420374722, 0.387406199, 0.364058672, 0.346466732, 0.332620417, 0.321364643, 0.311987171, 0.304015128, 0.29713267, 0.291110645, 0.28577389, 0.2810236, 0.276739237, 0.272855018, 0.269310216, 0.266058634,
0, 0.829043036, 0.571464492, 0.475009738, 0.42270608, 0.280140294, 0.365462346, 0.347637456, 0.333625812, 0.322246964, 0.312773677, 0.304726615, 0.297783006, 0.291711031, 0.286331125, 0.2810236, 0.276739237, 0.27331739, 0.269748999, 0.266476225,
0, 0.839595315, 0.575185353, 0.47709696, 0.424122385, 0.390224106, 0.366312443, 0.34834588, 0.334233536, 0.322780561, 0.313248861, 0.305156225, 0.298176353, 0.292072282, 0.28666766, 0.281859256, 0.277594257, 0.273596314, 0.270013393, 0.266727836,
0, 0.846861953, 0.577704088, 0.478503242, 0.425074282, 0.390938056, 0.366882271, 0.348820985, 0.334639543, 0.323136231, 0.313567108, 0.305444238, 0.298438866, 0.292314753, 0.286892183, 0.282069942, 0.277722233, 0.27378283, 0.270190674, 0.266895841,
0, 0.852166206, 0.579525369, 0.479517414, 0.425758382, 0.391450716, 0.36729192, 0.349160792, 0.334932076, 0.323392255, 0.313795387, 0.305649628, 0.298626913, 0.292488315, 0.287052772, 0.282220397, 0.277864224, 0.273916319, 0.270317028, 0.26701628,
0, 0.856208367, 0.580898883, 0.480279715, 0.426273813, 0.391837246, 0.367598406, 0.349415777, 0.335150969, 0.323583755, 0.313965828, 0.305804786, 0.298767881, 0.292618408, 0.298666068, 0.282332746, 0.27797004, 0.274016896, 0.270412054, 0.267106859,
0, 0.859394471, 0.581977326, 0.480877891, 0.426675769, 0.392136871, 0.367839092, 0.349616121, 0.335321792, 0.323733554, 0.314099947, 0.27116438, 0.298877714, 0.292719481, 0.287267995, 0.282421254, 0.278052741, 0.274094256, 0.270485928, 0.267176796,
0, 0.861964935, 0.582842289, 0.481357042, 0.427000068, 0.392378441, 0.368029972, 0.349775095, 0.3354579, 0.323854123, 0.314206534, 0.306020962, 0.298966175, 0.292800904, 0.287343111, 0.282491462, 0.278118473, 0.274156626, 0.270544471, 0.267233201,
0, 0.864087653, 0.583556544, 0.481748941, 0.427262784, 0.39257561, 0.368188513, 0.34990605, 0.33557047, 0.323951692, 0.314293437, 0.306100585, 0.299037697, 0.292866933, 0.287405049, 0.28254893, 0.278172628, 0.274207745, 0.27059352, 0.267278914,
0, 0.865875833, 0.584149683, 0.482076399, 0.427483788, 0.392740583, 0.368318699, 0.350015051, 0.33566396, 0.32403357, 0.314366551, 0.306166187, 0.299097622, 0.292922695, 0.287456271, 0.282596839, 0.27821829, 0.27425061, 0.270633797, 0.267317496,
0, 0.86738544, 0.584655141, 0.482355438, 0.427672095, 0.392880996, 0.368429973, 0.350106958, 0.335742848, 0.324102883, 0.314428824, 0.306221502, 0.299148623, 0.292969036, 0.287500072, 0.282637574, 0.278256224, 0.274286717, 0.270667493, 0.267350371,
0, 0.868696521, 0.585089577, 0.482595204, 0.42783128, 0.393001431, 0.368526374, 0.350186649, 0.335810495, 0.324162769, 0.314481232, 0.306269333, 0.299192479, 0.293009382, 0.287537272, 0.282672727, 0.278288747, 0.274317566, 0.270696801, 0.267378249,
0, 0.869829948, 0.585466383, 0.482800241, 0.427970436, 0.393104939, 0.368609237, 0.350255336, 0.335869145, 0.324214267, 0.314526732, 0.306311549, 0.299230081, 0.293044587, 0.28756952, 0.282703094, 0.278317404, 0.274344659, 0.27072245, 0.267401843,
0, 0.870829814, 0.585795628, 0.482982125, 0.428093187, 0.393196134, 0.368681264, 0.350315459, 0.335921045, 0.324259472, 0.314567297, 0.306347208, 0.299263214, 0.293074646, 0.287598467, 0.28272947, 0.278342194, 0.274367993, 0.270745172, 0.267423296,
0, 0.871710383, 0.586087456, 0.483143136, 0.42820134, 0.393276544, 0.36874516, 0.350369465, 0.335966188, 0.32429838, 0.314602924, 0.30637912, 0.299292771, 0.293102134, 0.287623283, 0.282752654, 0.278363888, 0.27438832, 0.270764232, 0.267441892,
0, 0.872501374, 0.586348631, 0.483285569, 0.428296707, 0.393347704, 0.368802278, 0.350416119, 0.336006828, 0.324334142, 0.314634599, 0.306408222, 0.299318751, 0.293126191, 0.287645621, 0.282773442, 0.278384036, 0.274407143, 0.270781828, 0.267458343,
0, 0.87320992, 0.586579071, 0.483414063, 0.42838294, 0.282336732, 0.36885261, 0.350457873, 0.33604296, 0.324365703, 0.31466232, 0.306433573, 0.299342046, 0.293147673, 0.28766548, 0.282791834, 0.278401087, 0.27442371, 0.270797227, 0.267473366,
0, 0.87384325, 0.586789032, 0.483528598, 0.428460029, 0.393469972, 0.368898874, 0.350495952, 0.336075711, 0.324394113, 0.314688065, 0.306456111, 0.299363553, 0.29316658, 0.287682858, 0.282808629, 0.278416589, 0.274438773, 0.270811894, 0.26748696,
0, 0.886226271, 0.590817514, 0.485731633, 0.429935553, 0.39456915, 0.369773255, 0.351222253, 0.336696936, 0.324938018, 0.315172068, 0.30689344, 0.299761989, 0.293534032, 0.28802424, 0.283127311, 0.278716122, 0.274720746, 0.271079112, 0.267737617)

int.K1 <- matrix(int.Krow, ncol = 20, byrow = T)

int.A2 <- c(0, 1.880603141, 1.023066041, 0.728508985, 0.576801714, 0.483324732, 0.419339282, 0.372553625, 0.336700337, 0.308214197,
0.285072182, 0.265815041, 0.249415556, 0.235334231, 0.223098119, 0.212344281, 0.202788984, 0.194260105, 0.186567417, 0.179603854,
0.173280485, 0.167478960, 0.162141846, 0.157220138, 0.152632918, 0.148422908, 0.144445902, 0.140786369, 0.137314768, 0.134048595,
0.131003138, 0.128130004, 0.125386067, 0.122820663, 0.120363768, 0.118035883, 0.115801118, 0.113706604, 0.111691342, 0.109750497,
0.107929345, 0.106147684, 0.104474928, 0.102834701, 0.101294133, 0.099780255, 0.098335949, 0.096957614, 0.095620578, 0.094322825,
0.093062478, 0.091858059, 0.090706954, 0.089567418, 0.088477672, 0.087416455, 0.086401328, 0.085393301, 0.084428606, 0.083487462,
0.082586678, 0.081707137, 0.080830726, 0.080008534, 0.079187956, 0.078385581, 0.077617182, 0.076865294, 0.076129334, 0.075408745,
0.074718677, 0.074027092, 0.073364697, 0.072715370, 0.072078685, 0.071454236, 0.070856317, 0.070255038, 0.069679267, 0.069099752,
0.068544794, 0.067999708, 0.067464204, 0.066951695, 0.066434399, 0.065939323, 0.065439219, 0.064960608, 0.064489832, 0.064026679,
0.063570942, 0.063122426, 0.062680941, 0.062246303, 0.061830756, 0.061409189, 0.061006179, 0.060597033, 0.060205939, 0.059820538)

int.D3 <- c(0, 0, 0, 0, 0, 0, 0.075591716, 0.136143309, 0.184040404, 0.223099415,
0.255625591, 0.283149171, 0.307194245, 0.328147931, 0.346601382, 0.363052095, 0.377842809, 0.391263736, 0.403496883, 0.414698795,
0.424933827, 0.434485467, 0.443312597, 0.451527599, 0.459374205, 0.467160192, 0.473736803, 0.479766327, 0.485655657, 0.491283407,
0.496539023, 0.501557139, 0.506467227, 0.511037240, 0.515510325, 0.519776912, 0.523955154, 0.527826636, 0.531619856, 0.535337344,
0.538768487, 0.542236872, 0.545430464, 0.548665075, 0.551634881, 0.554648545, 0.557506067, 0.560211151, 0.562866801, 0.565473544,
0.568032565, 0.570450872, 0.572732115, 0.575066257, 0.577266404, 0.579428914, 0.581463144, 0.583553436, 0.585519455, 0.587452468,
0.589265749, 0.591050397, 0.592893713, 0.594535951, 0.596238561, 0.597915941, 0.599484117, 0.601029791, 0.602554384, 0.604058044,
0.605459391, 0.606925251, 0.608290639, 0.609640325, 0.610974407, 0.612294228, 0.613519793, 0.614813030, 0.616015483, 0.617285538,
0.618466996, 0.619639163, 0.620803319, 0.621882184, 0.623032666, 0.624099878, 0.625239268, 0.626298598, 0.627354492, 0.628408180,
0.629460279, 0.630511403, 0.631562160, 0.632613760, 0.633592607, 0.634647413, 0.635631885, 0.636693461, 0.637685903, 0.638683948)

int.D4 <- c(0, 3.267287234, 2.574246899, 2.281301603, 2.114488392, 2.00394633, 1.924408284, 1.863856691, 1.815959596, 1.776900585,
1.744374409, 1.716850829, 1.692805755, 1.671852069, 1.653398618, 1.636947905, 1.622157191, 1.608736264, 1.596503117, 1.585301205,
1.575066173, 1.565514533, 1.556687403, 1.548472401, 1.540625795, 1.532839808, 1.526263197, 1.520233673, 1.514344343, 1.508716593,
1.503460977, 1.498442861, 1.493532773, 1.488962760, 1.484489675, 1.480223088, 1.476044846, 1.472173364, 1.468380144, 1.464662656,
1.461231513, 1.457763128, 1.454569536, 1.451334925, 1.448365119, 1.445351455, 1.442493933, 1.439788849, 1.437133199, 1.434526456,
1.431967435, 1.429549128, 1.427267885, 1.424933743, 1.422733596, 1.420571086, 1.418536856, 1.416446564, 1.414480545, 1.412547532,
1.410734251, 1.408949603, 1.407106287, 1.405464049, 1.403761439, 1.402084059, 1.400515883, 1.398970209, 1.397445616, 1.395941956,
1.394540609, 1.393074749, 1.391709361, 1.390359675, 1.389025593, 1.387705772, 1.386480207, 1.385186970, 1.383984517, 1.382714462,
1.381533004, 1.380360837, 1.379196681, 1.378117816, 1.376967334, 1.375900122, 1.374760732, 1.373701402, 1.372645508, 1.371591820,
1.370539721, 1.369488597, 1.368437840, 1.367386240, 1.366407393, 1.365352587, 1.364368115, 1.363306539, 1.362314097, 1.361316052)

intgrr.xr.range.fun <- function(x) {
    if (length(na.exclude(x)) == 0) {
        return(NA)
    }
    return(max(x, na.rm = T) - min(x, na.rm = T))
}

intgrr.xr.buildData <- function(x, k, n, r) {
    x[is.nan(x)] <- NaN
    testData <<- data.frame(testResult = x[1: (k * n * r)], Appraisers = rep(gl(k, r, k * r), n), Parts = gl(n, k * r, k * n * r))
    return(testData)
}

intgrr.xr.getSourceResult <- function(x, k, n, r,sig = 6, tole = NA, pap = 0.05) {
    if (!exists("testData")) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    xp <- numeric(0)
    for (i in 1 : n) {
        xp <- c(xp, mean(testData$testResult[testData$Parts == i], na.rm = T))
    }
    rp <- intgrr.xr.range.fun(xp)
    rdoublebar <- numeric(0)
    xdiff <- numeric(0)
    ra <- numeric(0)
    xa <- numeric(0)
    for (i in 1 : k) {
        rap <- numeric(0)
        xap <- numeric(0)
        for (j in 1 : n) {
            rap <- c(rap, intgrr.xr.range.fun(testData$testResult[testData$Parts == j & testData$Appraisers == i]))
            xap <- c(xap, mean(testData$testResult[testData$Parts == j & testData$Appraisers == i], na.rm = T))
        }
        ra <- c(ra, mean(rap, na.rm = T))
        xa <- c(xa, mean(xap, na.rm = T))
    }
    rdoublebar <- mean(ra, na.rm = T)
    xdiff <- intgrr.xr.range.fun(xa)
    k1factor <- NA
    if (n * k > 20) {
        k1factor <- int.K1[21, r]
    } else {
        k1factor <- int.K1[n * k, r]
    }
    k2factor <- int.K2[k]
    k3factor <- int.K3[n]
    if (n == 1 && k == 1 && r == 1) {
        k1factor <- NA
        k2factor <- NA
        k3factor <- NA
    }
    EV <- rdoublebar * k1factor
    if (is.na(EV)) {
        AV <- NA
    } else {
        if ((xdiff * k2factor) ^ 2 - (EV ^ 2) / (n * r) > 0) {
            AV <- sqrt((xdiff * k2factor) ^ 2 - (EV ^ 2) / (n * r))
        } else {
            AV <- 0
        }
    }
    GRR <- sqrt(EV ^ 2 + AV ^ 2)
    PV <- rp * k3factor
    TV <- sqrt(GRR ^ 2 + PV ^ 2)
    Sigma <- c(EV, AV, GRR, PV, TV)
    nSigma <- sig * Sigma
    va <- Sigma ^ 2
    Contribution <- va / va[5] * 100
    Variance <- Sigma / Sigma[5] * 100
    Tolerance <- nSigma / tole * 100
    Tolerance[Tolerance < 0 | Tolerance == Inf] <- NA
    result <- data.frame(va, Sigma, nSigma, Contribution, Variance, Tolerance)
    row.names(result) <- c("Repeatability", "Reproducibility", "Gauge R&R", "Parts", "Total")
    sourceResult <<- result
    return(result)
}

intgrr.xr.getXBBACResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    Xbar <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), mean, na.rm = T)
    Xbar <- Xbar$x
    if (r < 2 | r > 100) {
        UCL <- NA
        LCL <- NA
    } else {
        Rdata <- intgrr.xr.getRangeBACResult(x, k, n, r)$CenterLine
        UCL <- mean(Xbar, na.rm = T) + Rdata * int.A2[r]
        LCL <- mean(Xbar, na.rm = T) - Rdata * int.A2[r]
    }
    Xbar <- list(Values = Xbar, UCL = UCL, LCL = LCL, CenterLine = mean(Xbar, na.rm = T))
    return(Xbar)
}

intgrr.xr.getRangeBACResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    Rdata <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), intgrr.xr.range.fun)
    Rdata <- Rdata$x
    if (r < 2 | r > 100) {
        UCL <- NA
    } else {
        UCL <- mean(Rdata, na.rm = T) * int.D4[r]
        LCL <- mean(Rdata, na.rm = T) * int.D3[r]
    }
    Rdata <- list(Values = Rdata, UCL = UCL, LCL = LCL, CenterLine = mean(Rdata, na.rm = T))
    return(Rdata)
}

intgrr.xr.getRRBACResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    appraiser <- testData[order(testData$Appraisers, decreasing = F),]
    appraiserData <- matrix(appraiser$testResult, nrow = k, ncol = n * r, byrow = T)
    ave <- matrix(apply(appraiserData, 1, mean, na.rm = T))
    result <- list(Values = appraiserData, CL = as.vector(ave))
    return(result)
}

intgrr.xr.getRRBPCResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    part <- testData[order(testData$Parts, decreasing = F),]
    partData <- matrix(part$testResult, nrow = n, ncol = k * r, byrow = T)
    ave <- matrix(apply(partData, 1, mean, na.rm = T))
    result <- list(Values = partData, CL = as.vector(ave))
    return(result)
}

intgrr.xr.getAPCResult <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    Xbar <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), mean, na.rm = T)
    PAPlot <- matrix(Xbar$x, nrow = k, ncol = n, byrow = T)
    return(PAPlot)
}

intgrr.xr.getComponentCResult <- function(x, k, n, r, sig = 6, tole = NA, pap = 0.05) {
    if (!exists('sourceResult')) {
        sourceResult <<- intgrr.xr.getSourceResult(x, k, n, r, tole = tole)
    }
    sourceData <- sourceResult
    sourceData <- sourceData[-5, ]
    sourceData <- sourceData[, c(-1 : -3)]
    componentResult <- t(as.matrix(sourceData))
    rownames(componentResult) <- paste('%', rownames(componentResult))
    return(componentResult)
}

intgrr.xr.getGRRDataSheet <- function(x, k, n, r) {
    if (!exists('testData')) {
        testData <<- intgrr.xr.buildData(x, k, n, r)
    }
    ra <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), intgrr.xr.range.fun)
    av <- aggregate(testData$testResult, list(testData$Parts, testData$Appraisers), mean, na.rm = T)
    raP <- aggregate(testData$testResult, list(testData$Parts), intgrr.xr.range.fun)
    avP <- aggregate(testData$testResult, list(testData$Parts), mean, na.rm = T)
    result <- list(Mean = av, Range = ra, TotalMean = avP, TotalRange = raP)
    return(result)
}
